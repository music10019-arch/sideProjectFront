<!DOCTYPE html>   <!-- this is html file -->
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chris'Project</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <!-- å¼•å…¥ D3.js æ•¸æ“šå¯è¦–åŒ–åº« -->
    <script src="https://cdn.jsdelivr.net/npm/topojson/dist/topojson.min.js"></script>
    <!-- å¼•å…¥ TopoJSON åœ°ç†æ•¸æ“šè™•ç†åº« -->
    <style>
        <!-- * stands for å…¨å±€é¸æ“‡å™¨ï¼Œè¨­å®šæ‰€æœ‰å…ƒç´  -->
        * {
            margin: 0;
            padding: 0 px ;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f2f5;
            display: flex;    <!-- å› ç‚º block å…ƒç´ æœƒä½”æ»¿æ•´è¡Œï¼Œè‡ªå‹•æ›è¡Œï¼›è¦è¨­å®š flex é è¨­æ˜¯ flex-direction: rowï¼Œæ©«å‘æ’åˆ— -->
            height: 100vh;
            <!--  vh = viewport height æ•´å€‹ç€è¦½å™¨è¦–çª—çš„ 100% é«˜åº¦ ä½† å¾Œå…¶å¯¦æ²’å·® -->
        }

        .left-panel {
            width: 40%;
            background-color: white;
            box-shadow: 2px 0 8px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
            padding: 20px;
            border-right: 1px solid #ddd;
        }

        .right-panel {
            width: 60%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            background-color: #f9f9f9;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 30px;
        }

        h2 {
            color: #555;
            margin-bottom: 10px;
            font-size: 99px;
        }

        .control-panel {
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
        }

        .form-group {
            margin-bottom: 10px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #666;
            font-weight: 500;
            font-size: 24px;
        }

        select {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 24px;
            cursor: pointer;
            transition: border-color 0.3s ease;
        }

        select:hover {
            border-color: #4da6ff;
        }

        select:focus {
            outline: none;
            border-color: #2980b9;
            background-color: white;
        }

        select:disabled {
            background-color: #ecf0f1;
            cursor: not-allowed;
            color: #95a5a6;
        }

        .data-display {
            display: none;
            margin-top: 20px;
        }

        .data-display.show {
            display: block;
        }

        .data-display h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 16px;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }

        .district-section {
            margin-bottom: 20px;
            background-color: #f5f5f5;
            padding: 10px;
            border-radius: 3px;
            border-left: 4px solid #3498db;
        }

        .district-title {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 14px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        table thead {
            background-color: #3498db;
            color: white;
        }

        table th {
            padding: 8px;
            text-align: left;
            font-weight: 600;
        }

        table td {
            padding: 6px 8px;
            border-bottom: 1px solid #ddd;
        }

        table tbody tr:hover {
            background-color: #eeeeee;
        }

        .democrat {
            color: #0066cc;
            font-weight: 600;
        }

        .republican {
            color: #cc0000;
            font-weight: 600;
        }

        /* WIN é»¨çš„é¡è‰² */
        .win {
            color: #27ae60;
            font-weight: 600;
            background-color: rgba(45, 206, 137, 0.15);
            /* âœ… åŠ åŠé€æ˜ç¶ è‰²èƒŒæ™¯ */
            padding: 2px 4px;
            /* âœ… åŠ  padding è®“èƒŒæ™¯æ›´æ˜é¡¯ */
            border-radius: 3px;
            /* âœ… åœ“è§’æ•ˆæœ */
        }


          <!--   åœ°åœ–äº’å‹•æ¨£å¼-->

        svg {
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .state {
            fill: #e8f4f8;
            stroke: #999;
            stroke-width: 0.5px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .state:hover {
            fill: #4da6ff;
            stroke-width: 1.5px;
            filter: drop-shadow(0 0 3px rgba(0, 0, 0, 0.2));
        }

        .state.selected {
            fill: #ff6b6b;
            stroke-width: 2px;
        }

        /* é»‘è‰²æç¤ºæ¡† */
        #tooltip {
            position: fixed;
            background-color: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            pointer-events: none;
            display: none;
            z-index: 9999;
        }

        .message {
            text-align: center;
            color: #7f8c8d;
            padding: 20px;
            background-color: #ecf0f1;
            border-radius: 5px;
            margin-top: 10px;
            font-size: 14px;
        }

        .error {
            background-color: #fadbd8;
            color: #c0392b;
            padding: 12px;
            border-radius: 4px;
            margin-top: 10px;
            border-left: 4px solid #c0392b;
        }

        .success {
            background-color: #d5f4e6;
            color: #27ae60;
            padding: 12px;
            border-radius: 4px;
            margin-top: 10px;
            border-left: 4px solid #27ae60;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            margin: 10px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .stats {
            background-color: #ecf0f1;
            padding: 10px;
            border-radius: 4px;
            font-size: 12px;
            color: #555;
            margin-top: 10px;
        }

        .stats p {
            margin: 5px 0;
        }

        .title-bar {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }

        .title-bar h1 {
            margin-bottom: 10;
            flex: 1;
        }

        .state-badge {
            background-color: #3498db;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="left-panel">
        <div class="title-bar">
            <h1>ğŸ“Š Election Result</h1>
            <span class="state-badge" id="stateBadge" style="display: none;"></span>
        </div>

        <div class="control-panel">
            <div class="form-group">
                <label for="yearSelect">Choose Year:</label>
                <select id="yearSelect" disabled>
                    <option value="">-- Select One State First --</option>
                </select>
            </div>
        </div>

        <div id="message" class="message">
            ğŸ‘ˆ Select One State from the Right
        </div>

        <div id="errorMessage" class="error" style="display: none;"></div>

        <div class="data-display" id="dataDisplay">
            <h3 id="displayTitle">Election Result</h3>
            <div id="tableContainer"></div>
            <div class="stats" id="statsContainer"></div>
        </div>
    </div>

    <div class="right-panel">
        <h1>ğŸ—ºï¸ House Election Result and Map (2020-2024)</h1>
        <svg id="map"></svg>
    </div>

    <div id="tooltip"></div>

    <script>
        // API åŸºç¤ URLï¼ˆæ ¹æ“šéœ€è¦ä¿®æ”¹ï¼‰
        //  é€™æ¨£ä»¥å¾Œéœ€è¦API åªè¦æ›¿æ›è®Šæ•¸å°±å¥½
        const API_BASE = 'http://127.0.0.1:5000/api';

        // å·åç¸®å¯«æ˜ å°„
        const stateNameMap = {
            'AL': 'ALABAMA', 'AK': 'ALASKA', 'AZ': 'ARIZONA', 'AR': 'ARKANSAS', 'CA': 'CALIFORNIA',
            'CO': 'COLORADO', 'CT': 'CONNECTICUT', 'DE': 'DELAWARE', 'FL': 'FLORIDA', 'GA': 'GEORGIA',
            'HI': 'HAWAII', 'ID': 'IDAHO', 'IL': 'ILLINOIS', 'IN': 'INDIANA', 'IA': 'IOWA',
            'KS': 'KANSAS', 'KY': 'KENTUCKY', 'LA': 'LOUISIANA', 'ME': 'MAINE', 'MD': 'MARYLAND',
            'MA': 'MASSACHUSETTS', 'MI': 'MICHIGAN', 'MN': 'MINNESOTA', 'MS': 'MISSISSIPPI',
            'MO': 'MISSOURI', 'MT': 'MONTANA', 'NE': 'NEBRASKA', 'NV': 'NEVADA', 'NH': 'NEW HAMPSHIRE',
            'NJ': 'NEW JERSEY', 'NM': 'NEW MEXICO', 'NY': 'NEW YORK', 'NC': 'NORTH CAROLINA',
            'ND': 'NORTH DAKOTA', 'OH': 'OHIO', 'OK': 'OKLAHOMA', 'OR': 'OREGON', 'PA': 'PENNSYLVANIA',
            'RI': 'RHODE ISLAND', 'SC': 'SOUTH CAROLINA', 'SD': 'SOUTH DAKOTA', 'TN': 'TENNESSEE',
            'TX': 'TEXAS', 'UT': 'UTAH', 'VT': 'VERMONT', 'VA': 'VIRGINIA', 'WA': 'WASHINGTON',
            'WV': 'WEST VIRGINIA', 'WI': 'WISCONSIN', 'WY': 'WYOMING', 'DC': 'DISTRICT OF COLUMBIA'
        };

        let selectedState = null;
        let availableYears = [];

        // åœ°åœ–é…ç½®
        const width = 1000;
        const height = 600;

        const svg = d3.select('#map')
            .attr('width', width)
            .attr('height', height);

        const projection = d3.geoAlbersUsa()
            .fitSize([width, height], { type: 'Sphere' });

        const pathGenerator = d3.geoPath()
            .projection(projection);

  // /////////           åˆå§‹åŒ–å¹´ä»½ä¸‹æ‹‰åˆ—è¡¨ //////////////
        function initializeYears() {
            fetch(`${API_BASE}/years`)
                .then(response => response.json())
                .then(data => {
                    availableYears = data.years;
                    const select = document.getElementById('yearSelect');
                    select.innerHTML = '<option value="">-- é¸æ“‡å¹´ä»½ --</option>';
                    availableYears.forEach(year => {
                        const option = document.createElement('option');
                        option.value = year;
                        option.textContent = year + ' å¹´';
                        select.appendChild(option);
                    });
                })
                .catch(error => console.error('ç²å–å¹´ä»½å¤±æ•—:', error));
        }

        // åŠ è¼‰åœ°åœ–
        function loadMap() {
            fetch('https://cdn.jsdelivr.net/npm/us-atlas@3/states10m.json')
                .then(response => response.json())
                .then(topology => {
                    const states = topojson.feature(topology, topology.objects.states).features;

                    svg.selectAll('.state')
                        .data(states)
                        .enter()
                        .append('path')
                        .attr('class', 'state')
                        .attr('d', pathGenerator)
                        .on('click', function(event, d) {
                            // ç§»é™¤ä¹‹å‰çš„é¸æ“‡
                            d3.selectAll('.state').classed('selected', false);
                            d3.select(this).classed('selected', true);

                            const stateName = d.properties.name;
                            selectedState = stateName;

                            // æ›´æ–° UI
                            document.getElementById('stateBadge').textContent = stateName;
                            document.getElementById('stateBadge').style.display = 'inline-block';
                            document.getElementById('yearSelect').disabled = false;
                            document.getElementById('yearSelect').value = '';
                            document.getElementById('dataDisplay').classList.remove('show');
                            document.getElementById('message').style.display = 'block';
                            document.getElementById('errorMessage').style.display = 'none';

                            console.log('å·²é¸æ“‡å·:', stateName);
                        })
                        .on('mouseover', function(event, d) {
                            if (!d3.select(this).classed('selected')) {
                                d3.select(this).style('fill', '#4da6ff');
                            }
                            const tooltip = d3.select('#tooltip');
                            tooltip
                                .style('display', 'block')
                                .style('left', (event.pageX + 10) + 'px')
                                .style('top', (event.pageY - 10) + 'px')
                                .text(d.properties.name + ' - é»æ“ŠæŸ¥è©¢');
                        })
                        .on('mousemove', function(event) {
                            d3.select('#tooltip')
                                .style('left', (event.pageX + 10) + 'px')
                                .style('top', (event.pageY - 10) + 'px');
                        })
                        .on('mouseout', function() {
                            if (!d3.select(this).classed('selected')) {
                                d3.select(this).style('fill', null);
                            }
                            d3.select('#tooltip').style('display', 'none');
                        });
                })
                .catch(error => {
                    console.error('åœ°åœ–åŠ è¼‰å¤±æ•—:', error);
                    showError('ç„¡æ³•åŠ è¼‰åœ°åœ–æ•¸æ“š');
                });
        }

        // å¹´ä»½é¸æ“‡è®ŠåŒ–äº‹ä»¶
        document.getElementById('yearSelect').addEventListener('change', function() {
            const year = this.value;
            if (!year || !selectedState) {
                document.getElementById('dataDisplay').classList.remove('show');
                return;
            }

            loadElectionData(selectedState, year);
        });

        // ç²å–ä¸¦é¡¯ç¤ºé¸èˆ‰æ•¸æ“š
        function loadElectionData(state, year) {
            document.getElementById('message').style.display = 'none';
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('dataDisplay').classList.remove('show');

            const url = `${API_BASE}/state-districts?state=${encodeURIComponent(state)}&year=${year}`;

            fetch(url)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    displayData(data.data, state, year);
                })
                .catch(error => {
                    console.error('æ•¸æ“šåŠ è¼‰å¤±æ•—:', error);
                    showError(`ç„¡æ³•åŠ è¼‰ ${state} åœ¨ ${year} å¹´çš„æ•¸æ“š`);
                });
        }

        // é¡¯ç¤ºæ•¸æ“š
        function displayData(data, stateName, year) {
            const container = document.getElementById('tableContainer');
            const displayDiv = document.getElementById('dataDisplay');
            const title = document.getElementById('displayTitle');
            const statsDiv = document.getElementById('statsContainer');

            title.textContent = `${stateName} - ${year} å¹´çœ¾è­°é™¢é¸èˆ‰çµæœ`;

            if (data.length === 0) {
                container.innerHTML = '<div class="message">æ­¤å·åœ¨è©²å¹´åº¦æš«ç„¡æ•¸æ“š</div>';
                displayDiv.classList.add('show');
                return;
            }

            // æŒ‰ district åˆ†çµ„
            const grouped = {};
            data.forEach(row => {
                const district = row.district;
                if (!grouped[district]) {
                    grouped[district] = [];
                }
                grouped[district].push(row);
            });

            let html = '';
            let totalVotes = 0;
            let demVotes = 0;
            let repVotes = 0;

            Object.keys(grouped)
                .sort((a, b) => {
                    const aNum = parseInt(a);
                    const bNum = parseInt(b);
                    return isNaN(aNum) ? 1 : (isNaN(bNum) ? -1 : (aNum - bNum));
                })
                .forEach(district => {
                    html += `<div class="district-section">
                        <div class="district-title">
                            ğŸ“ ç¬¬ ${district === '0' ? 'å…¨å·' : district} é¸å€
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>å€™é¸äºº</th>
                                    <th>æ”¿é»¨</th>
                                    <th>å¾—ç¥¨æ•¸</th>
                                    <th>ç¸½ç¥¨æ•¸</th>
                                    <th>å¾—ç¥¨ç‡</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;

                    grouped[district].forEach(row => {
                        const partyClass = row.party === 'DEMOCRAT' ? 'democrat' : (row.party === 'REPUBLICAN' ? 'republican' : 'win');
                        const votes = row.candidatevotes;

                        totalVotes += row.totalvotes;
                        if (row.party === 'DEMOCRAT') {
                            demVotes += votes;
                        } else {
                            repVotes += votes;
                        }

                        html += `
                            <tr>
                                <td>${row.candidate}</td>
                                <td><span class="${partyClass}">${row.party}</span></td>
                                <td>${votes.toLocaleString()}</td>
                                <td>${row.totalvotes.toLocaleString()}</td>
                                <td>${row.vote_percentage.toFixed(2)}%</td>
                            </tr>
                        `;
                    });

                    html += `
                            </tbody>
                        </table>
                    </div>
                    `;
                });

            container.innerHTML = html;

            // é¡¯ç¤ºçµ±è¨ˆä¿¡æ¯
            statsDiv.innerHTML = `
                <p><strong>ğŸ“Š Your Analysis</strong></p>
                <p>æ°‘ä¸»é»¨: <span class="democrat">${demVotes.toLocaleString()}</span> ç¥¨</p>
                <p>å…±å’Œé»¨: <span class="republican">${repVotes.toLocaleString()}</span> ç¥¨</p>
                <p>é¸å€æ•¸: ${Object.keys(grouped).length}</p>
            `;

            displayDiv.classList.add('show');
            console.log(`å·²é¡¯ç¤º ${data.length} ç­†é¸èˆ‰æ•¸æ“š`);
        }

        // é¡¯ç¤ºéŒ¯èª¤ä¿¡æ¯
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = 'âŒ ' + message;
            errorDiv.style.display = 'block';
        }

        // åˆå§‹åŒ–æ‡‰ç”¨
        window.addEventListener('load', function() {
            console.log('æ‡‰ç”¨åˆå§‹åŒ–...');
            initializeYears();
            loadMap();
        });
    </script>
</body>
</html>